<?php
$root_dir = explode('html',__DIR__)[0] . html;

include "givemyprecious.php";
include "connection_agent.php";
require_once "${root_dir}/vendor/autoload.php";

$dblink = new mysqli($host, $dblogin, $dbpassw, $database); 
$bot = new \TelegramBot\Api\Client(${token});
//$bot->sendMessage(425486413, 'Test');

$query = "select telegram_users.Id_whitelist_user as 'Id', telegram_users.Id_telegram_user as 'Telegram' from telegram_users join white_list using (Id_whitelist_user) WHERE telegram_users.Id_whitelist_user != 11";
$result = mysqli_query($dblink, $query) or die("–û—à–∏–±–∫–∞ " . mysqli_error($dblink));
if($result)
{
	$count = mysqli_num_rows($result);
	for($i = 0; $i < $count; $i++)
	{
		$row = mysqli_fetch_row($result);
		if($row)
		{
			$id_user = $row[1];
			//show results code
										$query = "select offers.Internal_id, types.Type_name, flat_types.Typename, localities.Locality_name, districts.District_name, offers.Address, offers.Description, offers.Room_counts, offers.Floor, offers.Floors_total, offers.Area, offers.Lot_area, offers.Living_space, offers.Kitchen_space, offers.Price, offers.Image_url, offers.IsNew, offers.IsEdit from offers inner join bind_whitelist_distr_flats on offers.Id_type=bind_whitelist_distr_flats.Id_type AND offers.Id_locality=bind_whitelist_distr_flats.Id_locality AND (offers.Id_flat_type=bind_whitelist_distr_flats.Id_flat_type OR bind_whitelist_distr_flats.Id_flat_type=1) AND (offers.Id_district=bind_whitelist_distr_flats.Id_district OR bind_whitelist_distr_flats.Id_district=1) AND (offers.Room_counts=bind_whitelist_distr_flats.Room_counts OR bind_whitelist_distr_flats.Room_counts=0) inner join types on offers.Id_type=types.Id_type inner join flat_types on offers.Id_flat_type=flat_types.Id_flat_type INNER JOIN localities ON offers.Id_locality=localities.Id_locality inner join districts on offers.Id_district=districts.Id_district where bind_whitelist_distr_flats.Id_whitelist_user=" . $row[0] . " AND (offers.IsNew=1 OR offers.IsEdit=1);";
										$result_bind = mysqli_query($dblink, $query) or die("–û—à–∏–±–∫–∞ " . mysqli_error($dblink));
										if($result_bind)
										{
											//--get info code--//
											$row_bind_count = mysqli_num_rows($result_bind);
											if($row_bind_count > 0)
											{
												for($i = 0; $i < $row_bind_count; $i++)
												{
													$row_bind = mysqli_fetch_row($result_bind);
													
													$keyboard_inline = new \TelegramBot\Api\Types\Inline\InlineKeyboardMarkup(
														[
															[
																['text' => '–°—Å—ã–ª–∫–∞ –Ω–∞ —Å–∞–π—Ç', 'url' => 'http://an-gorod.com.ua/real/flat/sale?q=' . $row_bind[0]]
															]
														]
													);
													
													$offer_message = $row_bind[0];
													
													if($row_bind[15]==1) $offer_message = $offer_message . "\r\nüî•üî•–ù–æ–≤–∞—èüî•üî•";
													else if($row_bind[16]==1)$offer_message = $offer_message . "\r\n‚û°Ô∏è‚û°Ô∏è–û–±–Ω–æ–≤–ª–µ–Ω–∞‚¨ÖÔ∏è‚¨ÖÔ∏è";
													
													$offer_message = $offer_message . "\r\n" . $row_bind[2] . " " . $row_bind[7] . "-–∫–æ–º–Ω–∞—Ç–Ω–∞—è, " . $row_bind[1] . " \r\n" . $row_bind[3];
													
													if($row_bind[4] != 1)
													{
														$offer_message = $offer_message . ", " . $row_bind[4];
													}
													if($row_bind[5] != null)
													{
														$offer_message = $offer_message . ", " . $row_bind[5];
													}
													$offer_message = $offer_message . " \r\n" . $row_bind[8] . "/" . $row_bind[9] . " \n" . $row_bind[10] . "/" . $row_bind[12] . "/" . $row_bind[13] . " \r\n \n–¶–µ–Ω–∞: " . $row_bind[14] . "\n\n" . $row_bind[6];
													$bot->sendMessage($id_user, $offer_message, null, false, null, $keyboard_inline);
													
													
												}
												$keyboard = new \TelegramBot\Api\Types\ReplyKeyboardMarkup(
												[
													[
														['text'=>'–û–±–Ω–æ–≤–∏—Ç—å']
													]
												]);
												$bot->sendMessage($id_user, "–í—Å–µ–≥–æ ${row_bind_count} –æ–±—ä–µ–∫—Ç–æ–≤.", null, false, null, $keyboard);
											}
											//else $bot->sendMessage($id_user, "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –≤–∞—à–µ–º—É —Ä–∞–π–æ–Ω—É –Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ!", null, false, null, $keyboard);
											//--end get info code--//
										}
										else
										{
											//$bot->sendMessage($id_user, "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –≤–∞—à–µ–º—É —Ä–∞–π–æ–Ω—É –Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ!", null, false, null, $keyboard);
										}	
										mysqli_free_result($result_bind);
			
			//$bot->sendMessage($id_user, '–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –ü—Ä–æ—à—É –≤–∞—Å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø—Ä–∏—Ö–æ–¥–∏—Ç –ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –≤–∞—à–µ–º—É —Ä–∞–π–æ–Ω—É –∏–∑ –±–æ—Ç–∞. –ï—Å–ª–∏ –Ω–µ—Ç, —Å–æ–æ–±—â–∏—Ç–µ –≤ –í–∞–π–±–µ—Ä –ø–æ –Ω–æ–º–µ—Ä—É 095 147 37 11. –ó–∞—Ä–∞–Ω–µ–µ –≤–∞–º —Å–ø–∞—Å–∏–±–æ!');
		}
	}
	mysqli_free_result($result);
}
mysqli_close($dblink);
/*
//–∫–æ–º–∞–Ω–¥–∞ Start
$bot->command('start', function ($message) use ($bot) {
	include "connection_custom.php";
	$dblink = new mysqli($host, $dblogin, $dbpassw, $database); 
	$id_user = $message->getChat()->getId();
	$query = "SELECT * FROM custom_users where Iduser=${id_user};";
	
	$result = mysqli_query($dblink, $query) or die("–û—à–∏–±–∫–∞ " . mysqli_error($dblink));
	if($result)
	{
		$row = mysqli_fetch_row($result);
		
		if($row)
		{
			$bot->sendMessage($id_user, '–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, ' . $row[3] . "!");
		}
		else
		{
			mysqli_query($dblink,"INSERT INTO custom_users (Iduser,Status) VALUES ($id_user,0);") or die("–û—à–∏–±–∫–∞: " . mysqli_error($dblink));
			$bot->sendMessage($id_user, '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!');	
			$bot->sendMessage($id_user, '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏ —Å–≤–æ—ë –∏–º—è:');
		}
	}
	mysqli_free_result($result);
	mysqli_close($dblink);
});

//–∫–æ–º–∞–Ω–¥–∞ Help
$bot->command('help', function ($message) use ($bot) {
    $bot->sendMessage($message->getChat()->getId(), 'help');
});

//–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–µ–¥–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
$bot->on(function ($Update) use ($bot) {
    $message = $Update->getMessage();
	
	include "connection.php";
	$dblink = new mysqli($host, $dblogin, $dbpassw, $database); 
	$msg_text = htmlentities(mysqli_real_escape_string($dblink,$message->getText()));

	$id_user = $message->getChat()->getId();
	
	$query = "SELECT * FROM custom_users where Iduser=${id_user};";
	$result = mysqli_query($dblink, $query) or die("–û—à–∏–±–∫–∞ " . mysqli_error($dblink));

	if($result)
	{
		$row = mysqli_fetch_row($result);
		if($row)
		{
			$id_status = $row[2];
			//–ü–æ–ª—É—á–∏–ª–∏ 
			if($id_status == 0)
			{
				$id_status++;
				mysqli_query($dblink,"UPDATE custom_users SET Status=${id_status}, Username='${msg_text}' WHERE Id=" . $row[0] . ";") or die("–û—à–∏–±–∫–∞: " . mysqli_error($dblink));
				$bot->sendMessage($id_user, "–ü—Ä–∏—è—Ç–Ω–æ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—Å—è, ${msg_text}!");

				$keyboard = new \TelegramBot\Api\Types\ReplyKeyboardMarkup(
				[
					[
						['text'=>'1-–∫–æ–º–Ω–∞—Ç–Ω—ã–µ'],['text'=>'2-–∫–æ–º–Ω–∞—Ç–Ω—ã–µ']
					],
					[
						['text'=>'3-–∫–æ–º–Ω–∞—Ç–Ω—ã–µ'],['text'=>'4-–∫–æ–º–Ω–∞—Ç–Ω—ã–µ']
					],
					[
						['text'=>'–î–∞–ª—å—à–µ']
					]
				]);
                $bot->sendMessage($id_user, "–í—ã–±–µ—Ä–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç:", null, false, null, $keyboard);
			}
			else
			{
				if($msg_text == '–î–∞–ª—å—à–µ')
				{
					$id_status++;
					mysqli_query($dblink,"UPDATE custom_users SET Status=${id_status} WHERE Id=" . $row[0] . ";") or die("–û—à–∏–±–∫–∞: " . mysqli_error($dblink));
					if($id_status == 2)
					{
						$keyboard = new \TelegramBot\Api\Types\ReplyKeyboardMarkup(
						[
							[
								['text'=>'–ê–ª–µ–∫—Å–µ–µ–≤–∫–∞'],['text'=>'–ü–∞–≤–ª–æ–≤–æ –ü–æ–ª–µ']
							],
							[
								['text'=>'–°–∞–ª—Ç–æ–≤–∫–∞'],['text'=>'–•–æ–ª–æ–¥–Ω–∞—è –ì–æ—Ä–∞']
							],
							[
								['text'=>'–¶–µ–Ω—Ç—Ä'],['text'=>'–°–µ–≤. –°–∞–ª—Ç–æ–≤–∫–∞']
							],
							[
								['text'=>'–ü—Ä. –ì–∞–≥–∞—Ä–∏–Ω–∞'],['text'=>'–ù–æ–≤—ã–µ –î–æ–º–∞']
							],
							[
								['text'=>'–•–¢–ó'],['text'=>'–¶–µ–Ω—Ç—Ä. –†—ã–Ω–æ–∫']
							],
							[
								['text'=>'–û–¥–µ—Å—Å–∫–∞—è'],['text'=>'–ñ—É–∫–æ–≤—Å–∫–æ–≥–æ']
							],
							[
								['text'=>'–í—ã–±—Ä–∞—Ç—å –≤—Å–µ']
							],
							[
								['text'=>'–î–∞–ª—å—à–µ']
							]
						]);
						$bot->sendMessage($id_user, "–í—ã–±–µ—Ä–∏ —Ä–∞–π–æ–Ω—ã:", null, false, null, $keyboard);
					}
					else if($id_status == 3)
					{
						$keyboard = new \TelegramBot\Api\Types\ReplyKeyboardMarkup(
						[
							[
								['text'=>' –ú–µ–Ω–µ–µ 15000$'],['text'=>'15000-30000$']
							],
							[
								['text'=>'30000-60000$'],['text'=>'60000-90000$']
							],
							[
								['text'=>'–ë–æ–ª–µ–µ 90000$']
							],
							[
								['text'=>'–î–∞–ª—å—à–µ']
							]
						]);
						$bot->sendMessage($id_user, "–í—ã–±–µ—Ä–∏ –±—é–¥–∂–µ—Ç:", null, false, null, $keyboard);
					}
					else if($id_status == 4)
					{
						$keyboard = new \TelegramBot\Api\Types\ReplyKeyboardMarkup(
						[
							[
								['text'=>' ']
							]
						]);
						$bot->sendMessage($id_user, "–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:", null, false, null, $keyboard);
					}
				}
								
			}
			
		}
	}
	$bot->deleteMessage($id_user, $message->getMessageId());
	mysqli_free_result($result);
	mysqli_close($dblink);
    //$bot->sendMessage($id_user, "–¢—ã –Ω–∞–ø–∏—Å–∞–ª: " . $msg_text);
}, function () { return true; });
*/
//$bot->run();


?>